# Aws Amplify Cdk

## Generate an application

Run `nx g @nrwl/react:app my-app` to generate an application.

> You can use any of the plugins above to generate applications as well.

When using Nx, you can create multiple applications and libraries in the same workspace.

## Generate a library

Run `nx g @nrwl/react:lib my-lib` to generate a library.

> You can also use any of the plugins above to generate libraries as well.

Libraries are shareable across libraries and applications. They can be imported from `@aws-amplify-cdk/mylib`.

## Build

Run `nx build my-app` to build the project. The build artifacts will be stored in the `dist/` directory. Use the `--prod` flag for a production build.

## Understand your workspace

Run `nx graph` to see a diagram of the dependencies of your projects.

## Further help

Visit the [Nx Documentation](https://nx.dev) to learn more.

## Add CDK configuration

We would like to configure CDK as part of the project and apply the project's already defined linting and code formatting rules, but if you run `cdk init app --language=typescript` from the root directory you'll get an error

> `cdk init` cannot be run in a non-empty directory!

so create a dummy directory first and run it from there e.g. `cdk`. We'll update the files generated by CDK CLI.

Move the file `/cdk/cdk.json` to the root directory and update it to point to a different entry point:

```
-  "app": "npx ts-node --prefer-ts-exts bin/cdk.ts",
+  "app": "dist/infra/main.js",
```

rather than relying on AWS CDK to build the code we'll do it though our tools along with all the other apps. Also remove the following lines from `cdk.json` file as won't be required:

```
  ...
  "watch": {
    "include": [
      "**"
    ],
    "exclude": [
      "README.md",
      "cdk*.json",
      "**/*.d.ts",
      "**/*.js",
      "tsconfig.json",
      "package*.json",
      "yarn.lock",
      "node_modules",
      "test"
    ]
  },
  ...
```

Run `npm i --save-dev aws-cdk` and `npm i aws-cdk-lib constructs` to add the AWS CDK dependencies. The copy the content from the file `cdk/bin/cdk.ts` into `infra/src/main.ts`, and copy the file `cdk/lib/cdk-stack.ts` to `infra/src/main/app` and update the import in `main.ts` to point to it.

Now everything should be set up, so go ahead and build the infra by running `npm run build infra` and then you could deploy the app by running `cdk deploy`. As a final step, you could remove the dummy directory `cdk` as this is not needed anymore.
